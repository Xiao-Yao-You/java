<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hk.jigai.module.system.dal.mysql.userreport.UserReportMapper">

    <select id="statistics" resultMap="statisticsMap"
            parameterType="com.hk.jigai.module.system.controller.admin.userreport.vo.StatisticsReqVO">
        select user_id, user_nick_name, count(1) num, (DATEDIFF(#{dateReport[${0}]} , #{dateReport[${1}]}) - num) num2
        from hk_user_report
        where deleted = 0
          and type != '2'
          and dept_id=#{deptId}
          and (report_object like CONCAT('%,'
            , #{userId}
            , ',%')
           or report_object like CONCAT('%,'
            , #{userId}
            , ']')
           or report_object like CONCAT('['
            , #{userId}
            , ',%')
           or report_object = CONCAT('['
            , #{userId}
            , ']')
            )
          and date_report between #{dateReport[${0}]}
          and #{dateReport[${1}]}
        group by user_id, user_nick_name
        order by num desc
    </select>


    <select id="statisticsSelf" resultMap="statisticsMap"
            parameterType="com.hk.jigai.module.system.controller.admin.userreport.vo.StatisticsReqVO">
        select user_id, user_nick_name, count(1) num, (DATEDIFF(#{dateReport[${0}]} , #{dateReport[${1}]}) - num) num2
        from hk_user_report
        where deleted = 0
          and type != '2'
          and dept_id=#{deptId}
          and user_id = #{userId}
          and date_report between #{dateReport[${0}]}
          and #{dateReport[${1}]}
        group by user_id, user_nick_name
        order by num desc
    </select>

    <resultMap id="statisticsMap" type="com.hk.jigai.module.system.controller.admin.userreport.vo.StatisticsRespVO">
        <id property="userId" column="user_id"/>
        <result property="userNickName" column="user_nick_name"/>
        <result property="submitNum" column="num"/>
        <result property="unSubmitNum" column="num2"/>
    </resultMap>

    <select id="queryNotSubmitUser" resultType="String"
            parameterType="com.hk.jigai.module.system.controller.admin.userreport.vo.StatisticsReqVO">
        <![CDATA[
        select distinct d.nickname
        from (
                 select a.id, a.nickname, c.user_id as ke, count(1) num
                 from system_users a
                          join system_user_dept b on a.id = b.user_id and b.dept_id = #{deptId} and b.deleted = 0
                          left join hk_user_report c
                                    on a.id = c.user_id and b.dept_id = c.dept_id and c.deleted = 0 and c.type != '2'
            and c.date_report between #{dateReport[${0}]} and #{dateReport[${1}]}
                 where a.deleted=0 and a.status = 0
                 group by a.id, a.nickname, c.user_id
                 having (num
                      < DATEDIFF(#{dateReport[${0}]}
                      , #{dateReport[${1}]}))
                     or ke is null) d
        ]]>
    </select>

    <select id="querySummaryReport"
            parameterType="com.hk.jigai.module.system.controller.admin.userreport.vo.StatisticsReqVO"
            resultType="com.hk.jigai.module.system.dal.dataobject.userreport.UserSummaryReportDO">
        SELECT a.content as content,e.user_nick_name as userNickName,e.id as userReportId,
        a.situation,a.connect_id,a.connect_content,a.id as reportScheduleId,c.id as attentionUserId
        FROM hk_user_report e
        join hk_report_job_schedule a on e.id = a.user_report_id and a.deleted = 0
        left join hk_report_attention c on a.id = c.job_id and c.type = 0 and c.deleted=0 and c.user_id = #{userId}
        where
        e.deleted = 0
        -- 考虑部门不存在的人员的情况，比如一些虚拟账号，超管账号等
        <if test="deptId!=null and deptId !=''">
            and e.dept_id=#{deptId}
        </if>

        and e.date_report between #{dateReport[${0}]} and #{dateReport[${1}]}
        and (
        e.report_object like CONCAT('%,' , #{userId} , ',%')
        or e.report_object like CONCAT('%,' , #{userId} , ']')
        or e.report_object like CONCAT('[' , #{userId} , ',%')
        or e.report_object = CONCAT('[' , #{userId} , ']')
        )
        order by e.date_report desc ,e.user_id
    </select>

    <select id="queryAttentionList"
            resultType="com.hk.jigai.module.system.controller.admin.userreport.vo.AttentionAlertRespVO"
            parameterType="Long">
        select h.id, h.content
        from (select a.id, a.content, a.date_report
              from (select id, content, job_id, date_report from hk_report_attention where type = 0 and deleted = 0) a
                       join hk_report_job_schedule b on a.job_id = b.id and b.deleted = 0
                       join hk_user_report e on b.user_report_id = e.id and e.deleted = 0 and e.user_id = #{userId}
              union ALL
              select c.id, c.content, c.date_report
              from (select id, content, job_id, date_report from hk_report_attention where type = 1 and deleted = 0) c
                       join hk_report_job_plan d on c.job_id = d.id and d.deleted = 0
                       join hk_user_report f on d.user_report_id = f.id and f.deleted = 0 and f.user_id = #{userId}) h
        order by h.date_report desc
    </select>

    <select id="queryByschedule" parameterType="Long"
            resultType="com.hk.jigai.module.system.dal.dataobject.userreport.AttentionOtherInfoDO">
        select a.content,
               a.connect_content,
               b.user_id        as userId,
               b.user_nick_name as userNickName,
               b.date_report    as dateReport,
               b.report_object  as reportObject,
               b.dept_id        as deptId
        from hk_report_job_schedule a
                 join hk_user_report b on a.user_report_id = b.id and b.deleted = 0
        where a.id = #{jobId}
          and a.deleted = 0
    </select>

    <select id="queryByPlan" parameterType="Long"
            resultType="com.hk.jigai.module.system.dal.dataobject.userreport.AttentionOtherInfoDO">
        select a.content,
               b.user_id        as userId,
               b.user_nick_name as userNickName,
               b.date_report    as dateReport,
               b.report_object  as reportObject,
               b.dept_id        as deptId
        from hk_report_job_plan a
                 join hk_user_report b on a.user_report_id = b.id and b.deleted = 0
        where a.id = #{jobId}
          and a.deleted = 0
    </select>
</mapper>